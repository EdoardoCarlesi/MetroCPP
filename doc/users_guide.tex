\documentclass{article}
\usepackage{hyperref}
\usepackage[utf8]{inputenc}
\usepackage[english]{babel}
\usepackage[parfill]{parskip}

\pagenumbering{Roman}
\pagenumbering{arabic}
\title{\textbf{METROC++} \\
\emph{A parallel, object-oriented code for the computation of merger trees in 
cosmological simulations}}
\author{Edoardo Carlesi\\ Leibniz Institut f\"ur Astrophysik\\ Potsdam, Germany\\ ecarlesi@aip.de}

\begin{document}
\maketitle
\tableofcontents
\newpage

\section{Introduction}
\texttt{METROC++} is an acronym that stands for \textbf{ME}rger\textbf{TR}ees \textbf{O}n \textbf{C++}, and refers to the 
infamous \textbf{Metro C} subway line in Rome, where the author of the code grew up and lived for more than 20 years.
This legendary piece of infrastructure (which is still - in 2019 - largely under construction, though a shorter section of 
it is already operating) took something of the order of a few Giga-Years to be build, a time span which can be compared to the
formation time of most dark matter halos.\\

The code is distributed under the GPL 

The code has been written in \texttt{C++} and relies on \texttt{MPI2.0 C-}bindings for the parallelization; 
implementing \texttt{C++11} and \texttt{C++14} directives - in particular, regarding the manipulation
of (ordered) maps, so that the source needs to be compiled with a non-prehistoric version of the compiler.
A series of python and \texttt{bash} scripts for the post processing, analysis and visualization of the merger trees are also provided 
together with the sources, inside the \texttt{scripts/} and \texttt{python/} subfolders.

The structure of the algorithms of the code as well as its performance, cosmological applications and 
physical modelling are described in the:
\href{https://arxiv.org/abs/1612.07053}{code paper} (Carlesi, MNRAS, 2018).

In this user's guide, we provide the basics for the setup and running of \texttt{METROC++}


\section{Basic usage}
\subsection{Compiling the code}

The main folder contains a \texttt{Makefile.config} file 

\begin{itemize}
\item {-DCMP_MAP}: This flag controls the core algorithm for the comparison of the particle content of the different halos.
It is strongly advised to use this flag unless there is a severe shortage of memory. When this flag is switched on, the particles
on each task are stored in a C++11 map-type object, which speeds up the comparison by (at least) a factor of 5, up to a factor of
20 for very large data. 
However, maps come with a substantial amount of overhead, and the total memory required on each task is around three times the 
memory required for the "standard" algorithm, which is based on the pairwise comparison of particle contents of nearby halos.

\item {-DZOOM}: When this flag is switched on, the comparison algorithm is optimized for the comparison of the 
particle content of halos in zoom-in simulations. This means that only one particle type will be

\item {-DVERBOSE}: This flag controls the output of the program - when enabled, the code will dump a lot more of 
(boring) information at runtime, on inter-task communication, buffer sizes, number of particles and halos exchanged and so on.

\item {-DNPTYPES=}

\end{itemize}

\subsection{Code operation modes}

The code has two basic modes of operation: \emph{tree-building} and \emph{post-processing}.

\subsection{Configuration file}
\subsection{Temporary files}

The code produces a number of temporary files (\texttt{.tmp} format extension, located in the \texttt{tmp/} folder).
These files are needed at runtime to 
They can be produced manually or using the scripts (\texttt{find\_z.sh}, \texttt{find\_n.sh} located in the \texttt{scripts/} folder)
and contain the list of files on which the halo finder will run on.
This can be the full list of snapshots in one simulation, or can be edited to be only a subset of it.

\section{Editing the code}
\subsection{Code structure}

\begin{itemize}
\item{\texttt{main.cpp}} A wrapper for the functions determined elsewhere
\item{\texttt{utils.cpp}} General functions and utilities are implemented here
\item{\texttt{spline.cpp}} The spline class is used for interpolation 
\item{\texttt{global\_vars.cpp}} A list of global variables accessible throughout the whole program
\item{\texttt{MergerTree.cpp}} This file contains the merger tree class, that tracks the merging of the halos, and series of functions (FindProgenitors) that compute the trees themselves
\item{\texttt{IOSetting.cpp}} Input/Output settings
\item{\texttt{Cosmology.cpp}} Everything related to cosmological calculations
\item{\texttt{Communication.cpp}} Handles most of the communication among tasks - sending / receiving buffers and so on
\item{\texttt{Grid.cpp}} This handles the grid on which halos are placed and the buffers
\item{\texttt{Halo.cpp}} The halo class contains the main halo properties
\end{itemize}

\subsection{Other halo finders}

Although \texttt{METROC++} was conceived and mainly tested using the \texttt{AHF} halo finder, it can be easily extended to 
support other software as well, as long as:

\begin{itemize}
\item Halo catalogues include informations about the number and types of particles, positions and velocities for each object
\item Particle catalogs contain the (unique) IDs for each halo particles' content
\end{itemize}

To add 

\subsection{Improving the algorithms}

\section{Examples}

\subsection{Full box simulation}
To properly run the code for full box simulations, the \texttt{-DZOOM} flag needs to be commented in the \texttt{Makefile.config} file.

\subsection{Zoom simulation}
To properly run the code on zoom simulation, the \texttt{-DZOOM} flag needs to be switched on in the \texttt{Makefile.config} file.


\end{document}

